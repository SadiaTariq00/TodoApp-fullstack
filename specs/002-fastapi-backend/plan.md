# Implementation Plan: FastAPI Backend with JWT Auth and Neon PostgreSQL

**Branch**: `002-fastapi-backend` | **Date**: 2026-01-06 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-fastapi-backend/spec.md`

## Summary

Build a secure, production-grade FastAPI backend that integrates with the completed Next.js frontend using JWT authentication from Better Auth and persistent storage via Neon PostgreSQL. The backend provides REST API endpoints for task CRUD operations with strict per-user data isolation, comprehensive validation, and proper error handling. All implementation follows constitutional mandates and aligns with the existing frontend API contracts to ensure zero frontend code changes.

**Core Value**: Enable authenticated users to create, read, update, delete, and toggle completion of their personal todo tasks through a secure REST API that enforces complete data isolation between users.

**Technical Approach**: FastAPI async framework with SQLModel ORM, PyJWT for HS256 token validation, Neon Serverless PostgreSQL with asyncpg driver, dependency injection for sessions and auth, modular router-based architecture.

---

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI 0.109+, SQLModel 0.0.14, asyncpg 0.29.0, PyJWT 2.8.0
**Storage**: Neon Serverless PostgreSQL (asyncpg connection)
**Testing**: pytest with httpx AsyncClient
**Target Platform**: Linux server / Docker container (ASGI with Uvicorn)
**Project Type**: Web application (backend only - pairs with existing Next.js frontend)
**Performance Goals**: <500ms p95 latency for CRUD operations, 50+ concurrent users
**Constraints**: Zero frontend changes, 100% user data isolation, no secret exposure
**Scale/Scope**: Multi-user system with ~1000 tasks per user expected, 6 REST endpoints

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ Passes All Gates

| Constitutional Rule | Status | Evidence |
|---------------------|--------|----------|
| **§1: Agentic Dev Stack** | ✅ PASS | Following spec → plan → tasks → Claude Code workflow |
| **§2: Spec Authority** | ✅ PASS | All design derived from `specs/002-fastapi-backend/spec.md` |
| **§3: Technology Stack - Backend** | ✅ PASS | Using FastAPI + SQLModel as mandated |
| **§3: Technology Stack - Database** | ✅ PASS | Using Neon Serverless PostgreSQL as mandated |
| **§3: Technology Stack - Auth** | ✅ PASS | JWT tokens from Better Auth (frontend) validated in backend |
| **§4: Application Scope** | ✅ PASS | Task CRUD only, no disallowed features (AI, file uploads, etc.) |
| **§5: REST API & Security** | ✅ PASS | All endpoints under `/api`, JWT required, ownership enforced |
| **§6: Monorepo Structure** | ✅ PASS | Backend lives in `/backend` directory per mandate |
| **§7: Agent Governance** | ✅ PASS | All code generated by Claude Code, no manual coding |
| **§8: Documentation** | ✅ PASS | CLAUDE.md exists in `/backend`, README planned |
| **§9: Quality & Validation** | ✅ PASS | Spec-compliant, modular, minimal, secure design |

**No violations**. All constitutional requirements satisfied.

---

## Project Structure

### Documentation (this feature)

```text
specs/002-fastapi-backend/
├── spec.md              # Feature specification (source of truth)
├── plan.md              # This file (architectural design)
├── research.md          # Phase 0: Technology decisions & rationale
├── data-model.md        # Phase 1: Entity definitions & validation rules
├── quickstart.md        # Phase 1: Developer setup guide
├── contracts/           # Phase 1: API contracts
│   ├── openapi.yaml     # OpenAPI 3.1.0 specification
│   └── README.md        # API documentation & examples
└── tasks.md             # Phase 2: Implementation tasks (NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── main.py              # FastAPI app, CORS, router mounting, startup/shutdown
├── db.py                # Async SQLModel engine, session factory, database utilities
├── models.py            # SQLModel table definitions (Task), request/response schemas
├── dependencies.py      # FastAPI dependencies (get_db, get_current_user)
├── auth/
│   └── jwt.py           # JWT decoding, validation, user extraction, error handling
├── routes/
│   └── tasks.py         # Task CRUD endpoints (all 6 endpoints)
├── tests/
│   ├── conftest.py      # Test fixtures (test DB, auth tokens, test client)
│   ├── test_auth.py     # JWT validation tests (401/403 scenarios)
│   ├── test_tasks_crud.py # Happy path CRUD operation tests
│   ├── test_isolation.py  # Cross-user access prevention tests
│   ├── test_validation.py # Input validation tests (422 errors)
│   └── test_edge_cases.py # Edge case tests (DB failures, concurrency)
├── .env                 # Environment variables (gitignored)
├── .env.example         # Example environment config
├── requirements.txt     # Python dependencies with versions
├── CLAUDE.md            # Claude Code rules for backend
└── README.md            # Setup instructions, API docs, deployment guide
```

**Structure Decision**: Web application (backend only). Modular router-based architecture for maintainability following FastAPI best practices. Separation of concerns: auth, models, database, routes in distinct modules. Dependency injection for sessions and auth enables testability.

---

## Complexity Tracking

> **No complexity violations detected.**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| _None_ | _N/A_ | _All design choices align with constitution and follow FastAPI conventions_ |

---

## Ready for Implementation

**Artifacts Generated**:
- ✅ research.md - All technical decisions documented
- ✅ data-model.md - Entity definitions and validation rules
- ✅ contracts/openapi.yaml - Complete API specification
- ✅ contracts/README.md - API documentation and examples
- ✅ quickstart.md - Developer setup guide
- ✅ plan.md - This architectural plan (complete)

**Next Steps**:
1. Run `/sp.tasks` to generate detailed implementation tasks
2. Begin implementation using Claude Code
3. Follow test-driven development approach
4. Integrate with frontend after core endpoints complete
5. Deploy to staging environment
6. Validate all success criteria met

**References**:
- Feature Specification: [spec.md](./spec.md)
- Technical Research: [research.md](./research.md)
- Data Model: [data-model.md](./data-model.md)
- API Contracts: [contracts/openapi.yaml](./contracts/openapi.yaml)
- Developer Guide: [quickstart.md](./quickstart.md)
- Constitution: [../../.specify/memory/constitution.md](../../.specify/memory/constitution.md)

---

**Plan Status**: ✅ Complete
**Constitutional Compliance**: ✅ All gates passed
**Next Command**: `/sp.tasks`
